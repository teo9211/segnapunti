<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archery Tracker - Il Tuo Diario di Tiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Stile personalizzato per l'aspetto Nero/Arancione e per le tabelle */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Sfondo scuro quasi nero */
            color: #fdb927; /* Arancione acceso per il testo */
        }
        .app-container {
            min-height: 100vh;
        }
        .btn-primary {
            background-color: #fdb927;
            color: #1a1a1a;
            font-weight: 800;
            transition: transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #e5a400;
            transform: scale(1.02);
        }
        .input-style {
            background-color: #2c2c2c;
            border: 1px solid #4a4a4a;
            color: #fdb927;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        /* Stile per la griglia di punteggio */
        .score-grid th, .score-grid td {
            border: 1px solid #4a4a4a;
            padding: 0.3rem 0.1rem;
            text-align: center;
            font-size: 0.8rem;
            line-height: 1;
        }
        .score-grid th {
            background-color: #2c2c2c;
            color: #fdb927;
            font-weight: 600;
        }
        .score-input {
            width: 100%;
            height: 100%;
            background-color: transparent;
            border: none;
            outline: none;
            text-align: center;
            font-weight: 800;
            color: #fff;
            padding: 0;
            font-size: 1rem;
        }
        /* Rendi la griglia scrollabile orizzontalmente su mobile */
        .grid-wrapper {
            overflow-x: auto;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#1a1a1a',
                        'primary-orange': '#fdb927',
                        'secondary-dark': '#2c2c2c',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-dark text-primary-orange">

    <div id="app" class="app-container p-4 max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold tracking-tight text-white">Archery Tracker</h1>
            <p class="text-sm mt-1 text-primary-orange">Il tuo diario di allenamenti e gare</p>
        </header>

        <div id="content-view">
            </div>

        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div id="modal-content" class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border-2 border-primary-orange">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 text-white">Titolo</h3>
                <p id="modal-body" class="mb-6 text-sm"></p>
                <div id="modal-actions" class="flex justify-end space-x-3">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importazioni AGGIORNATE alla versione 12.6.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Variabili globali fornite dall'ambiente Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-archery-tracker-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Configurazione di default, usata se __firebase_config non è disponibile (ad esempio, per test locali)
        // ORA USA LA TUA CONFIGURAZIONE FORNITA (segnapunti-29e7d)
        const rawFirebaseConfig = {
            apiKey: "AIzaSyBXBhK1WL8781xQ0iGoSkbEK6rCNAg8-UA",
            authDomain: "segnapunti-29e7d.firebaseapp.com",
            projectId: "segnapunti-29e7d",
            storageBucket: "segnapunti-29e7d.firebasestorage.app",
            messagingSenderId: "804710490002",
            appId: "1:804710490002:web:0d93df922327b04d3d6b4b"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : rawFirebaseConfig;
        
        // Inizializzazione Firebase
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('debug'); // Abilita i log per il debug

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Funzione di utility per ottenere il percorso della collezione privata
            window.getSessionsCollectionRef = () => {
                if (!userId || !db) return null;
                return collection(db, `artifacts/${appId}/users/${userId}/sessions`);
            };

            // 1. Ascolta i cambiamenti di stato dell'autenticazione
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log('Autenticazione riuscita. User ID:', userId);
                } else {
                    console.log('Nessun utente autenticato. Tentativo di accesso anonimo.');
                    try {
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                    } catch (error) {
                        console.error("Errore nell'accesso anonimo:", error);
                    }
                }
                isAuthReady = true;
                // Una volta che l'autenticazione è pronta, inizializza l'applicazione principale
                window.initializeApp(db, userId);
            });

            // 2. Tenta di autenticarsi con il token personalizzato se disponibile
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(error => {
                    console.error("Errore nell'autenticazione con token personalizzato:", error);
                });
            } else if (!auth.currentUser) {
                // Se non c'è token e non è già loggato, l'onAuthStateChanged gestirà l'anonimo
            }

        } catch (e) {
            console.error("Errore nell'inizializzazione di Firebase:", e);
        }

        // =================================================================================
        // Logica dell'Applicazione (eseguita dopo l'autenticazione)
        // =================================================================================
        window.initializeApp = (db, currentUserId) => {
            if (!currentUserId) return; // Non procedere senza ID utente

            const appState = {
                view: 'mainMenu', // 'mainMenu', 'registrationForm', 'scoring', 'dataSummary', 'detailedSummary'
                sessionType: null, // 'Allenamento' or 'Gara'
                currentSession: null, // Dati del form
                currentTurn: 1, // 1 or 2
                sessionData: [], // Array dei documenti dal Firestore
                detailedSession: null, // Sessione per il riepilogo dettagliato
                scoringGrid: null, // Griglia punteggi corrente
                userId: currentUserId,
            };

            // Stato per la gestione della griglia punteggi
            const scoringState = {
                rows: 0, // Numero di volè
                cols: 3, // Numero di frecce per volè (3 o 6)
                format: null, // '3x10', '6x6', '6x12'
                activeCell: { row: 1, col: 1 }, // Cella attiva per l'inserimento
                startTime: null, // Tempo di inizio sessione per la durata
            };

            // Costanti e Opzioni
            const TIPO_TARGA_OPTIONS = ['40', '60', '80', '120', 'Tripla', 'Tripla Vegas', 'Field', '3D', 'Altro'];
            const DISTANZA_OPTIONS = ['18mt', '25mt', '40mt', '50mt', '60mt', '70mt'];
            const TIPO_LUOGO_OPTIONS = ['Indoor', 'Outdoor'];
            const FORMATO_GARA_OPTIONS = ['30 frecce (3x10)', '36 frecce (6x6)', '72 frecce (6x12)'];
            const KEYPAD_VALUES = ['X', '10', '9', '8', '7', '6', '5', '4', '3', '2', '1', 'M', 'CANC'];

            // =================================================================================
            // FUNZIONI DI UTILITY
            // =================================================================================

            function pad(num) {
                return num < 10 ? '0' + num : num;
            }

            function getFormattedTime(date) {
                return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
            }

            function durationToString(minutes) {
                if (!minutes) return 'N/A';
                const h = Math.floor(minutes / 60);
                const m = Math.round(minutes % 60);
                return `${h} ore e ${m} min`;
            }

            function getScoreValue(value) {
                if (value === 'X') return 10;
                if (value === 'M' || value === 'm') return 0;
                return parseInt(value) || 0;
            }

            function formatScores(scores) {
                const parts = scores.map(s => {
                    const val = getScoreValue(s);
                    // Mappa M a 0, X a 10, e numeri
                    if (s === 'X') return 'X';
                    if (s === 'M') return 'M';
                    return val > 0 ? val.toString() : 'M';
                });

                // Aggiunge celle vuote se la volè non è completa
                while (parts.length < scoringState.cols) {
                    parts.push('');
                }
                return parts;
            }

            // =================================================================================
            // LOGICA DI CALCOLO DEL PUNTEGGIO
            // =================================================================================

            function calculateVolley(volleyScores, cumulativeTotal) {
                let parziale = 0;
                let xCount = 0;
                let tenCount = 0; // Contatore per i 10 esterni (non X)
                let nineCount = 0;

                for (const score of volleyScores) {
                    const val = getScoreValue(score);
                    parziale += val;

                    if (score === 'X') {
                        xCount++;
                    } else if (val === 10) {
                        // Se il punteggio è 10, e NON è 'X', conta come 10 esterno.
                        // Usiamo 'score' per differenziare la stringa 'X' dalla stringa '10'.
                        if (score === '10') {
                            tenCount++;
                        }
                    } else if (val === 9) {
                        nineCount++;
                    }
                }

                return {
                    scores: volleyScores,
                    parziale: parziale,
                    totale: cumulativeTotal + parziale,
                    // Modifica: Mostra il conteggio X e 10 esterni come richiesto (X-10)
                    X10: `${xCount}-${tenCount}`,
                    nine: nineCount,
                    x: xCount, // per il totale finale
                    ten: tenCount, // per il totale finale
                };
            }

            function calculateTurnScores(grid) {
                let cumulativeTotal = 0;
                let totalX = 0;
                let totalTen = 0;
                let totalNine = 0;
                let totalShots = 0;

                const results = [];

                for (let i = 0; i < grid.length; i++) {
                    const volleyScores = grid[i].filter(s => s !== '' && s !== undefined);
                    
                    // Solo calcola se ci sono frecce nella volè
                    if (volleyScores.length > 0) {
                        const volleyResult = calculateVolley(volleyScores, cumulativeTotal);
                        
                        cumulativeTotal = volleyResult.totale;
                        totalX += volleyResult.x;
                        totalTen += volleyResult.ten;
                        totalNine += volleyResult.nine;
                        totalShots += volleyScores.length;

                        results.push({
                            volley: i + 1,
                            ...volleyResult
                        });
                    }
                }

                const totalScore = cumulativeTotal;
                const totalFrecce = scoringState.rows * scoringState.cols;
                const maxScore = totalFrecce * 10;
                const average = totalShots > 0 ? (totalScore / totalShots) : 0;
                
                return {
                    score: totalScore,
                    X: totalX, // Totale X
                    Ten: totalTen, // Totale 10 (non X)
                    Nine: totalNine,
                    average: average,
                    frecceTirate: totalShots,
                    maxScore: maxScore,
                    volleys: results, // Dati dettagliati di ogni volè
                };
            }

            // =================================================================================
            // GESTIONE VISTE E UI - ESPONIAMO QUESTE FUNZIONI GLOBALMENTE
            // =================================================================================

            function showModal(title, body, actions = []) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = body;
                
                const actionsContainer = document.getElementById('modal-actions');
                actionsContainer.innerHTML = '';
                actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-primary px-4 py-2 rounded-lg font-semibold';
                    btn.textContent = action.text;
                    btn.onclick = () => {
                        action.handler();
                        closeModal();
                    };
                    actionsContainer.appendChild(btn);
                });

                document.getElementById('modal').classList.remove('hidden');
            }

            function closeModal() {
                document.getElementById('modal').classList.add('hidden');
            }

            // **FUNZIONE GLOBALE:** Spostata fuori ma chiamata qui
            window.setView = (viewName, data = {}) => {
                appState.view = viewName;
                document.getElementById('content-view').innerHTML = '';
                closeModal(); // Chiude eventuali modali aperte

                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot(); // Scollega il listener quando si cambia vista
                }

                switch (viewName) {
                    case 'mainMenu':
                        renderMainMenu();
                        break;
                    case 'registrationForm':
                        renderRegistrationForm(data.type);
                        break;
                    case 'scoring':
                        initializeScoringGrid();
                        renderScoringView();
                        break;
                    case 'dataSummary':
                        fetchSessions();
                        renderDataSummary();
                        break;
                    case 'detailedSummary':
                        appState.detailedSession = data.session;
                        renderDetailedSummary();
                        break;
                    case 'charts':
                        renderChartsView();
                        break;
                }
            };
            
            // **FUNZIONE GLOBALE:** Spostata fuori ma chiamata qui
            window.handleFilterChange = (field, value) => {
                filterState[field] = value;
                fetchSessions(); // Riesegue la query con i nuovi filtri
            };

            // **FUNZIONE GLOBALE:** Spostata fuori ma chiamata qui
            window.handleCellClick = (row, col) => {
                scoringState.activeCell = { row, col };
                renderScoringView(); // Ridisegna per evidenziare la nuova cella attiva
            };

            // **FUNZIONE GLOBALE:** Spostata fuori ma chiamata qui
            window.handleKeypadInput = (value) => {
                const { row, col } = scoringState.activeCell;
                const rowIndex = row - 1;
                const colIndex = col - 1;

                // Controlli di validità
                if (rowIndex < 0 || rowIndex >= scoringState.rows) return;
                
                // Gestione CANC
                if (value === 'CANC') {
                    if (appState.scoringGrid[rowIndex][colIndex] !== '') {
                        appState.scoringGrid[rowIndex][colIndex] = ''; // Cancella
                    } else {
                        // Se la cella è vuota, torna indietro alla precedente
                        let newCol = colIndex - 1;
                        let newRow = rowIndex;
                        if (newCol < 0) {
                            newRow = rowIndex - 1;
                            newCol = scoringState.cols - 1;
                        }
                        if (newRow >= 0) {
                            scoringState.activeCell = { row: newRow + 1, col: newCol + 1 };
                        }
                        appState.scoringGrid[rowIndex][colIndex] = '';
                    }
                } else {
                    // Gestione Inserimento Punteggio
                    const scoreValue = (value === '10' ? '10' : value).toUpperCase();
                    appState.scoringGrid[rowIndex][colIndex] = scoreValue;

                    // Avanza alla prossima cella
                    let newCol = colIndex + 1;
                    let newRow = rowIndex;

                    if (newCol >= scoringState.cols) {
                        newCol = 0; // Inizia dalla prima colonna
                        newRow = rowIndex + 1; // Prossima riga
                    }

                    if (newRow < scoringState.rows) {
                        scoringState.activeCell = { row: newRow + 1, col: newCol + 1 };
                    } else {
                        // Fine della griglia, sposta il focus all'ultima cella riempita
                        scoringState.activeCell = { row: scoringState.rows, col: scoringState.cols };
                    }
                }
                renderScoringView();
            };

            // **FUNZIONE GLOBALE:** Spostata fuori ma chiamata qui
            window.saveTurn = (isFinal) => {
                const turnKey = `turn${appState.currentTurn}`;
                const turnResults = calculateTurnScores(appState.scoringGrid);

                // Controllo che il turno sia completo (almeno un punteggio in tutte le volè)
                if (turnResults.frecceTirate !== (scoringState.rows * scoringState.cols)) {
                    // Avvisa che non tutte le frecce sono state tirate
                    showModal("Turno Incompleto", "Non tutte le volè hanno il numero massimo di frecce inserite. Si desidera salvare comunque?", [
                        { text: "Annulla", handler: () => {} },
                        { text: "Salva Incompleto", handler: () => confirmSave(isFinal, turnKey, turnResults) }
                    ]);
                } else {
                    confirmSave(isFinal, turnKey, turnResults);
                }
            };
            
            // Funzioni helper interne
            function confirmSave(isFinal, turnKey, turnResults) {
                // 1. Salva i risultati del turno nello stato
                appState.currentSession[turnKey].summary = turnResults;
                
                let modalBody = `
                    <p class="text-lg font-bold mb-3 text-white">Riepilogo Turno ${appState.currentTurn}</p>
                    <ul class="space-y-1 text-sm">
                        <li><strong>Punteggio Totale:</strong> <span class="text-primary-orange font-bold">${turnResults.score}</span> / ${turnResults.maxScore}</li>
                        <li><strong>Media per freccia:</strong> <span class="text-primary-orange font-bold">${turnResults.average.toFixed(2)}</span></li>
                        <li><strong>X Totali:</strong> ${turnResults.X}</li>
                        <li><strong>10 Totali:</strong> ${turnResults.Ten}</li>
                        <li><strong>9 Totali:</strong> ${turnResults.Nine}</li>
                    </ul>
                `;

                // 2. Determina le azioni successive
                let actions = [];
                const format = appState.currentSession.formatoGara;

                if (isFinal) {
                    // Logica FINE ALLENAMENTO/GARA
                    const endTime = new Date();
                    appState.currentSession.endTime = getFormattedTime(endTime);
                    appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);
                    
                    // IL SALVATAGGIO SU FIREBASE AVVIENE QUI
                    saveSessionToFirestore();
                    
                    modalBody += `<p class="mt-4 text-white">Sessione completata. Durata: ${durationToString(appState.currentSession.duration)}.</p>`;
                    actions.push({ text: "Torna al Menu", handler: () => window.setView('mainMenu') });
                } else if (appState.currentTurn === 1 && format !== '72 frecce (6x12)') {
                    // Logica Primo Turno (non turno unico: 30 o 36 frecce)
                    actions.push({ text: "Prosegui con Secondo Turno", handler: () => startNextTurn() });
                    actions.push({ text: "Fine Allenamento (Salva Turno Unico)", handler: () => window.saveTurn(true) });
                } else {
                    // Se siamo al Turno 2 o se il formato è 72 frecce (già completo), chiudiamo.
                    const endTime = new Date();
                    appState.currentSession.endTime = getFormattedTime(endTime);
                    appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);
                    saveSessionToFirestore();
                    modalBody += `<p class="mt-4 text-white">Sessione completata. Durata: ${durationToString(appState.currentSession.duration)}.</p>`;
                    actions.push({ text: "Torna al Menu", handler: () => window.setView('mainMenu') });
                }
                
                showModal("Turno Salvato!", modalBody, actions);
            }

            function startNextTurn() {
                if (appState.currentTurn === 1) {
                    appState.currentTurn = 2;
                }
                window.setView('scoring');
            }

            function calculateDuration(startTimeStr, endTimeStr) {
                const date = new Date().toISOString().split('T')[0];
                const start = new Date(`${date}T${startTimeStr}`);
                const end = new Date(`${date}T${endTimeStr}`);
                
                // Se l'ora di fine è prima dell'ora di inizio (es. sessione oltre mezzanotte, improbabile)
                if (end < start) {
                    end.setDate(end.getDate() + 1);
                }
                
                const diffMs = end - start;
                return Math.round(diffMs / (1000 * 60)); // Durata in minuti
            }

            // CORREZIONE 1: Aggiunta/Modifica della funzione prepareTurnData
            function prepareTurnData(turn) {
                if (!turn || !turn.grid) return null;
                
                // CONVERSIONE CHIAVE: Serializza la griglia 2D (Array annidato)
                // in un array di stringhe JSON, una per ogni riga (volè).
                const serializedGrid = turn.grid.map(row => JSON.stringify(row));

                return {
                    summary: turn.summary,
                    // Salva la griglia in formato supportato (array di stringhe)
                    grid: serializedGrid
                };
            }

            // CORREZIONE 2: Modifica della funzione saveSessionToFirestore
            async function saveSessionToFirestore() {
                try {
                    const session = appState.currentSession;
                    const results = calculateTotalSessionResults(session);

                    // Prepara i dati del turno 1 serializzando la griglia
                    const turn1Data = prepareTurnData(session.turn1);
                    
                    // Prepara i dati del turno 2 serializzando la griglia (se esiste)
                    const turn2Data = session.turn2 ? prepareTurnData(session.turn2) : null;
                    
                    const finalSessionData = {
                        ...session,
                        ...results,
                        timestamp: serverTimestamp(),
                        userId: appState.userId,
                        turn1: turn1Data, // Dati serializzati
                        turn2: turn2Data, // Dati serializzati o null
                    };

                    const docRef = await addDoc(window.getSessionsCollectionRef(), finalSessionData);
                    console.log("Documento scritto con ID: ", docRef.id);
                    
                    // Resetta lo stato dopo il salvataggio
                    appState.currentSession = null;
                    appState.currentTurn = 1;

                } catch (e) {
                    console.error("Errore nell'aggiunta del documento: ", e);
                    showModal("Errore di Salvataggio", "Non è stato possibile salvare la sessione. Controlla la console per i dettagli.", [{ text: "Ok", handler: () => {} }]);
                }
            }

            // CORREZIONE 3: Modifica per gestire i valori undefined nel Turno 2
            function calculateTotalSessionResults(session) {
                // Inizializza il riepilogo del Turno 1 (dovrebbe sempre esistere se arriviamo qui)
                const turn1Summary = session.turn1?.summary || { score: 0, X: 0, Ten: 0, Nine: 0, frecceTirate: 0, average: 0 };
                
                // Inizializza il riepilogo del Turno 2. Se non esiste, usiamo un oggetto con tutti i valori a 0.
                const turn2Summary = session.turn2?.summary || { score: 0, X: 0, Ten: 0, Nine: 0, frecceTirate: 0, average: 0 };
                
                const totalScore = turn1Summary.score + turn2Summary.score;
                const totalShots = turn1Summary.frecceTirate + turn2Summary.frecceTirate;

                return {
                    totalScore: totalScore,
                    totalX: turn1Summary.X + turn2Summary.X,
                    totalTen: turn1Summary.Ten + turn2Summary.Ten,
                    totalNine: turn1Summary.Nine + turn2Summary.Nine,
                    totalAverage: totalShots > 0 ? (totalScore / totalShots) : 0,
                    
                    turn1Score: turn1Summary.score,
                    turn1Average: turn1Summary.average,
                    
                    // Questi valori saranno 0 se il Turno 2 non è stato completato
                    turn2Score: turn2Summary.score,
                    turn2Average: turn2Summary.average, 
                };
            }

            // =================================================================================
            // VISTA 1: MENU PRINCIPALE
            // =================================================================================

            function renderMainMenu() {
                const html = `
                    <div class="text-center space-y-4">
                        <h2 class="text-2xl font-bold mb-6 text-white">Seleziona un'azione</h2>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('registrationForm', { type: 'Allenamento' })">Allenamento</button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('registrationForm', { type: 'Gara' })">Gara</button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('dataSummary')">Riepilogo Dati</button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg opacity-50 cursor-not-allowed">Grafici Andamento (Prossimamente)</button>
                    </div>
                `;
                document.getElementById('content-view').innerHTML = html;
            }

            // =================================================================================
            // VISTA 2: FORM DI REGISTRAZIONE
            // =================================================================================

            function renderRegistrationForm(type) {
                appState.sessionType = type;
                scoringState.startTime = getFormattedTime(new Date());

                // Imposta i valori di default se è il primo accesso o se non ci sono dati correnti
                const session = appState.currentSession || {};
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                const defaultTime = `${pad(now.getHours())}:${pad(now.getMinutes())}`;

                const formFields = [
                    { id: 'arciere', label: 'Arciere', type: 'text', required: true, value: session.arciere || '', placeholder: 'Nome Arciere' },
                    { id: 'data', label: 'Data', type: 'date', required: true, value: session.data || today }, // USIAMO data
                    { id: 'ora', label: 'Ora', type: 'time', required: true, value: session.startTime || defaultTime, placeholder: 'HH:MM' },
                    { id: 'luogo', label: 'Luogo', type: 'text', required: true, value: session.luogo || '', placeholder: 'Nome Luogo' },
                    { id: 'tipoLuogo', label: 'Tipo Luogo', type: 'select', options: TIPO_LUOGO_OPTIONS, required: true, value: session.tipoLuogo || '' },
                    { id: 'distanza', label: 'Distanza', type: 'select', options: DISTANZA_OPTIONS, required: true, value: session.distanza || '' },
                    { id: 'tipoTarga', label: 'Tipo Targa', type: 'select', options: TIPO_TARGA_OPTIONS, required: true, value: session.tipoTarga || '' },
                    { id: 'formatoGara', label: 'Formato Freccia', type: 'select', options: FORMATO_GARA_OPTIONS, required: true, value: session.formatoGara || '' },
                    { id: 'note', label: 'Note', type: 'textarea', required: false, value: session.notes || '', placeholder: 'Dettagli aggiuntivi...' },
                ];

                const html = `
                    <h2 class="text-3xl font-bold mb-6 text-white">${type}</h2>
                    <form id="registrationForm" class="space-y-4">
                        ${formFields.map(field => `
                            <div>
                                <label for="${field.id}" class="block text-sm font-medium mb-1">${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                                ${field.type === 'select' ? `
                                    <select id="${field.id}" name="${field.id}" class="input-style" ${field.required ? 'required' : ''}>
                                        <option value="" disabled>Seleziona ${field.label}</option>
                                        ${field.options.map(opt => `<option value="${opt}" ${field.value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                ` : field.type === 'textarea' ? `
                                    <textarea id="${field.id}" name="${field.id}" class="input-style h-20" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>${field.value}</textarea>
                                ` : `
                                    <input type="${field.type}" id="${field.id}" name="${field.id}" class="input-style" value="${field.value}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
                                `}
                            </div>
                        `).join('')}

                        <div class="mt-8 flex flex-col space-y-3">
                            <button type="submit" id="startTurnButton" class="btn-primary w-full p-3 rounded-lg text-lg">
                                Inizia Primo Turno
                            </button>
                            <button type="button" class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                                Torna Indietro
                            </button>
                        </div>
                    </form>
                `;
                document.getElementById('content-view').innerHTML = html;

                document.getElementById('registrationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    // Salva i dati del form nello stato
                    const formData = new FormData(e.target);
                    const session = Object.fromEntries(formData.entries());
                    session.type = appState.sessionType;
                    session.startTime = scoringState.startTime;
                    session.id = Date.now(); // ID temporaneo per la sessione corrente
                    appState.currentSession = session;

                    window.setView('scoring');
                });
            }

            // =================================================================================
            // VISTA 3: GRIGLIA DI PUNTEGGIO
            // =================================================================================

            function initializeScoringGrid() {
                const format = appState.currentSession.formatoGara;

                if (format.includes('3x10')) {
                    scoringState.rows = 10;
                    scoringState.cols = 3;
                    scoringState.format = '3x10';
                } else if (format.includes('6x6')) {
                    scoringState.rows = 6;
                    scoringState.cols = 6;
                    scoringState.format = '6x6';
                } else if (format.includes('6x12')) {
                    scoringState.rows = 12;
                    scoringState.cols = 6;
                    scoringState.format = '6x12';
                }

                // Inizializza o ripristina la griglia per il turno corrente
                const turnKey = `turn${appState.currentTurn}`;
                if (!appState.currentSession[turnKey] || !appState.currentSession[turnKey].grid) {
                    // Crea una matrice vuota: righe x colonne per i punteggi
                    const grid = Array(scoringState.rows).fill(null).map(() => Array(scoringState.cols).fill(''));
                    appState.currentSession[turnKey] = { grid: grid, summary: null };
                }
                
                appState.scoringGrid = appState.currentSession[turnKey].grid;
                scoringState.activeCell = { row: 1, col: 1 };
            }

            function renderScoringView() {
                const session = appState.currentSession;
                const turnKey = `turn${appState.currentTurn}`;
                const format = scoringState.format;
                
                let cumulativeTotalForView = 0; // Inizializza il totale cumulativo per la visualizzazione

                // Calcola sequenzialmente i dati della griglia per la visualizzazione
                const gridData = appState.scoringGrid.map((row) => {
                    const volleyResult = calculateVolley(row, cumulativeTotalForView);
                    cumulativeTotalForView = volleyResult.totale; 
                    return volleyResult;
                });

                // Genera l'HTML della griglia
                const tableHtml = `
                    <div class="grid-wrapper">
                        <table id="scoreTable" class="score-grid w-full table-fixed min-w-[500px] border-collapse">
                            <thead>
                                <tr class="text-xs sm:text-sm">
                                    <th class="w-[10%]">Volè</th>
                                    ${Array(scoringState.cols).fill(0).map((_, i) => `<th class="w-[8%]">${i + 1}</th>`).join('')}
                                    <th class="w-[10%]">Parz.</th>
                                    <th class="w-[10%]">Tot.</th>
                                    <th class="w-[12%]">X-10</th>
                                    <th class="w-[8%]">9</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array(scoringState.rows).fill(0).map((_, i) => {
                                    const row = gridData[i]; // Utilizza il dato già calcolato
                                    const volleyNum = i + 1;
                                    const isComplete = appState.scoringGrid[i].every(s => s !== '' && s !== undefined);

                                    // L'oggetto 'row' contiene i dati calcolati (parziale, totale, X10, nine)
                                    
                                    return `
                                        <tr id="volley-row-${volleyNum}" class="${i % 2 === 0 ? 'bg-secondary-dark' : 'bg-gray-800'} text-xs sm:text-base ${isComplete ? 'text-white' : 'text-primary-orange'}">
                                            <td class="font-bold">${volleyNum}</td>
                                            ${Array(scoringState.cols).fill(0).map((_, colIndex) => {
                                                const isActive = scoringState.activeCell.row === volleyNum && scoringState.activeCell.col === colIndex + 1;
                                                const score = appState.scoringGrid[i][colIndex];
                                                return `
                                                    <td class="score-cell ${isActive ? 'bg-primary-orange text-black font-extrabold shadow-inner' : ''}" 
                                                        data-row="${volleyNum}" data-col="${colIndex + 1}"
                                                        onclick="window.handleCellClick(${volleyNum}, ${colIndex + 1})">
                                                        ${score || ''}
                                                    </td>
                                                `;
                                            }).join('')}
                                            <td class="font-bold text-white">${row.parziale || ''}</td>
                                            <td class="font-bold text-white">${row.totale || ''}</td>
                                            <td>${row.X10 || ''}</td>
                                            <td>${row.nine || ''}</td>
                                        </tr>
                                    `;
                                }).join('')}
                                ${(() => {
                                    const totalResults = calculateTurnScores(appState.scoringGrid);
                                    return `
                                        <tr class="bg-primary-orange text-black font-extrabold text-xs sm:text-base">
                                            <td colspan="${1 + scoringState.cols + 1}" class="text-right pr-4">Totale Turno (${session.type})</td>
                                            <td class="font-extrabold">${totalResults.score}</td>
                                            <td>${totalResults.X}-${totalResults.Ten}</td> 
                                            <td>${totalResults.Nine}</td>
                                        </tr>
                                    `;
                                })()}
                            </tbody>
                        </table>
                    </div>
                `;

                // Genera l'HTML del tastierino
                const keypadHtml = `
                    <div class="mt-6">
                        <h3 class="text-xl font-bold mb-3 text-white">Tastierino Punteggi</h3>
                        <div class="grid grid-cols-4 gap-2 sm:grid-cols-5 md:grid-cols-7">
                            ${KEYPAD_VALUES.map(val => `
                                <button class="keypad-btn bg-secondary-dark border-2 border-primary-orange text-white p-3 rounded-xl text-xl font-bold transition duration-150 ease-in-out hover:bg-primary-orange hover:text-black hover:shadow-lg"
                                        onclick="window.handleKeypadInput('${val}')">
                                    ${val}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Azioni
                const sessionType = appState.sessionType; // Cache the value safely
                const actionsHtml = `
                    <div class="mt-8 flex flex-col space-y-3">
                        ${(appState.currentTurn === 2 && format !== '6x12') || (format === '6x12' && appState.currentTurn === 1) ? `
                            <button class="btn-primary w-full p-3 rounded-lg text-lg" onclick="window.saveTurn(true)">
                                Fine Allenamento / Gara (Salva Risultati)
                            </button>
                        ` : `
                            <button class="btn-primary w-full p-3 rounded-lg text-lg" onclick="window.saveTurn(false)">
                                Salva Turno
                            </button>
                        `}
                        
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('registrationForm', { type: '${sessionType}' })">
                            Torna Indietro
                        </button>
                    </div>
                `;

                document.getElementById('content-view').innerHTML = `
                    <h2 class="text-3xl font-bold mb-4 text-white">${session.type} - Turno ${appState.currentTurn}</h2>
                    <p class="text-sm mb-4">Arciere: ${session.arciere} | Distanza: ${session.distanza} | Formato: ${session.formatoGara}</p>
                    ${tableHtml}
                    ${keypadHtml}
                    ${actionsHtml}
                `;
            }

            // =================================================================================
            // VISTA 4: RIEPILOGO DATI (Tabella)
            // =================================================================================

            let unsubscribeSnapshot = null;
            let filterState = {
                distanza: '',
                tipoTarga: '',
                type: '',
                arciere: '',
            };

            function fetchSessions() {
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot(); // Scollega il listener precedente
                }
                
                const sessionsColRef = window.getSessionsCollectionRef();
                if (!sessionsColRef) {
                    console.error("Riferimento collezione non disponibile.");
                    return;
                }

                let q = query(sessionsColRef);
                
                // Filtri
                if (filterState.distanza) q = query(q, where('distanza', '==', filterState.distanza));
                if (filterState.tipoTarga) q = query(q, where('tipoTarga', '==', filterState.tipoTarga));
                if (filterState.type) q = query(q, where('type', '==', filterState.type));
                // Filtro arciere (non ideale per Firestore, si filtra in memoria)

                // Ordine: data crescente (basato sul campo data stringa) - Manteniamo l'ordine in JS per evitare problemi di indice
                
                // onSnapshot per il real-time
                unsubscribeSnapshot = onSnapshot(q, (querySnapshot) => {
                    const sessions = [];
                    querySnapshot.forEach((doc) => {
                        sessions.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordina i dati in memoria per data (crescente)
                    sessions.sort((a, b) => new Date(a.data) - new Date(b.data)); // USIAMO a.data e b.data

                    // Filtra per arciere in memoria
                    let filteredSessions = sessions;
                    if (filterState.arciere) {
                        const filterText = filterState.arciere.toLowerCase();
                        filteredSessions = sessions.filter(s => s.arciere.toLowerCase().includes(filterText));
                    }

                    appState.sessionData = filteredSessions;
                    renderDataSummaryTable(); // Ridisegna solo la tabella
                }, (error) => {
                    console.error("Errore in onSnapshot:", error);
                });
            }

            
            function renderDataSummary() {
                const distinctArchers = Array.from(new Set(appState.sessionData.map(s => s.arciere))).sort();

                const filtersHtml = `
                    <div class="mb-6 p-4 bg-secondary-dark rounded-xl shadow-lg grid grid-cols-2 gap-3 md:grid-cols-5">
                        <select class="input-style text-sm" onchange="window.handleFilterChange('type', this.value)">
                            <option value="">Tutti i Tipi</option>
                            <option value="Allenamento" ${filterState.type === 'Allenamento' ? 'selected' : ''}>Allenamento</option>
                            <option value="Gara" ${filterState.type === 'Gara' ? 'selected' : ''}>Gara</option>
                        </select>
                        <select class="input-style text-sm" onchange="window.handleFilterChange('distanza', this.value)">
                            <option value="">Tutte le Distanze</option>
                            ${DISTANZA_OPTIONS.map(opt => `<option value="${opt}" ${filterState.distanza === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                        <select class="input-style text-sm" onchange="window.handleFilterChange('tipoTarga', this.value)">
                            <option value="">Tutte le Targhe</option>
                            ${TIPO_TARGA_OPTIONS.map(opt => `<option value="${opt}" ${filterState.tipoTarga === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                        <select class="input-style text-sm" onchange="window.handleFilterChange('arciere', this.value)">
                            <option value="">Tutti gli Arcieri</option>
                            ${distinctArchers.map(opt => `<option value="${opt}" ${filterState.arciere === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                        <button class="btn-primary p-2 text-sm" onclick="window.handleFilterChange('arciere', '')">Rimuovi Filtri</button>
                    </div>
                `;

                const tableContainer = `<div id="dataSummaryTable" class="grid-wrapper"></div>`;

                document.getElementById('content-view').innerHTML = `
                    <h2 class="text-3xl font-bold mb-6 text-white">Riepilogo Dati (User ID: ${appState.userId})</h2>
                    ${filtersHtml}
                    ${tableContainer}
                    <button class="btn-primary w-full p-3 rounded-lg mt-6 bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                        Torna al Menu Principale
                    </button>
                `;

                renderDataSummaryTable(); // Iniziale disegno della tabella
            }

            function renderDataSummaryTable() {
                const tableContainer = document.getElementById('dataSummaryTable');
                if (!tableContainer) return;

                const tableHtml = `
                    <table class="score-grid w-full table-auto min-w-[1000px] border-collapse">
                        <thead>
                            <tr class="text-xs sm:text-sm">
                                <th>Data</th>
                                <th>Arciere</th>
                                <th>Tipo</th>
                                <th>Tot.</th>
                                <th>T1</th>
                                <th>T2</th>
                                <th>X</th>
                                <th>10</th>
                                <th>9</th>
                                <th>Luogo</th>
                                <th>Distanza</th>
                                <th>Targa</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appState.sessionData.length === 0 ? `
                                <tr><td colspan="12" class="p-4 text-center">Nessuna sessione trovata.</td></tr>
                            ` : appState.sessionData.map(session => `
                                <tr class="${session.type === 'Gara' ? 'bg-orange-900 bg-opacity-30' : 'bg-gray-800'} hover:bg-secondary-dark cursor-pointer text-xs sm:text-sm"
                                    onclick="window.setView('detailedSummary', { session: ${JSON.stringify(session).replace(/'/g, '&#39;')} })">
                                    <td class="font-bold text-primary-orange underline">${session.data || 'N/D'}</td> <td>${session.arciere}</td>
                                    <td>${session.type}</td>
                                    <td class="font-extrabold text-white">${session.totalScore || 0}</td>
                                    <td>${session.turn1Score || 0}</td>
                                    <td>${session.turn2Score || 0}</td>
                                    <td>${session.totalX || 0}</td>
                                    <td>${session.totalTen || 0}</td>
                                    <td>${session.totalNine || 0}</td>
                                    <td>${session.luogo}</td>
                                    <td>${session.distanza}</td>
                                    <td>${session.tipoTarga}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                tableContainer.innerHTML = tableHtml;
            }

            // =================================================================================
            // VISTA 5: RIEPILOGO DETTAGLIATO
            // =================================================================================

            function renderDetailedSummary() {
                const session = appState.detailedSession;
                if (!session) {
                    window.setView('dataSummary');
                    return;
                }

                const T1 = session.turn1.summary;
                const T2 = session.turn2?.summary || { score: 0, X: 0, Ten: 0, Nine: 0, average: 0 };
                
                const html = `
                    <h2 class="text-3xl font-bold mb-4 text-white">${session.type} del ${session.data || 'N/D'}</h2> <p class="text-xl mb-6 text-primary-orange">Arciere: ${session.arciere} | ${session.distanza} | ${session.tipoTarga}</p>

                    <div class="space-y-6">
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                            <h3 class="text-2xl font-bold mb-3 text-white">Statistiche Generali</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>Durata:</strong> ${durationToString(session.duration)}</div>
                                <div><strong>Luogo:</strong> ${session.luogo} (${session.tipoLuogo})</div>
                                <div><strong>Punteggio Totale:</strong> <span class="text-white font-extrabold">${session.totalScore}</span></div>
                                <div><strong>Media per Freccia:</strong> <span class="text-white font-extrabold">${session.totalAverage.toFixed(2)}</span></div>
                            </div>
                            <div class="mt-3 p-2 bg-gray-800 rounded-lg">
                                <strong>Totali X-10/9:</strong> 
                                <span class="text-white font-extrabold">${session.totalX}-${session.totalTen}</span> / 9: ${session.totalNine}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${renderTurnSummaryCard(session.turn1, 'Primo Turno', 'T1')}
                            ${session.turn2 ? renderTurnSummaryCard(session.turn2, 'Secondo Turno', 'T2') : ''}
                        </div>

                        <h3 class="text-2xl font-bold mb-3 mt-8 text-white">Segnapunti Dettagliato</h3>
                        ${renderDetailedScoreGrid(session.turn1, 'Primo Turno')}
                        ${session.turn2 ? renderDetailedScoreGrid(session.turn2, 'Secondo Turno') : ''}
                    </div>

                    <button class="btn-primary w-full p-3 rounded-lg mt-8" onclick="window.setView('dataSummary')">
                        Torna al Riepilogo Dati
                    </button>
                `;
                document.getElementById('content-view').innerHTML = html;
            }

            function renderTurnSummaryCard(turn, title, prefix) {
                const summary = turn.summary;
                if (!summary) return '';
                return `
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                        <h4 class="text-xl font-bold mb-2 text-white">${title}</h4>
                        <ul class="space-y-1 text-sm">
                            <li><strong>Punteggio:</strong> <span class="text-white font-extrabold">${summary.score}</span> / ${summary.maxScore}</li>
                            <li><strong>Media:</strong> ${summary.average.toFixed(2)}</li>
                            <li><strong>X-10/9:</strong> X-10: <span class="text-white font-extrabold">${summary.X}-${summary.Ten}</span>, 9: ${summary.Nine}</li>
                        </ul>
                    </div>
                `;
            }

            // FUNZIONE AGGIUNTA/MODIFICATA PER LA LETTURA DEL DATO SERIALIZZATO
            function deserializeGrid(turn) {
                if (!turn || !turn.grid || turn.grid.length === 0) return [];
                
                // Converti l'array di stringhe JSON in un array 2D di punteggi
                return turn.grid.map(rowStr => JSON.parse(rowStr));
            }

            function renderDetailedScoreGrid(turn, title) {
                // CHIAVE: Deserializza la griglia qui
                const grid2D = deserializeGrid(turn); 
                
                // Ricalcola i volleys per la visualizzazione dettagliata
                let cumulativeTotalForView = 0;
                const volleys = grid2D.map(row => {
                    const volleyResult = calculateVolley(row, cumulativeTotalForView);
                    cumulativeTotalForView = volleyResult.totale; 
                    return volleyResult;
                });

                if (!volleys || volleys.length === 0) return '';
                
                // Determina il numero di colonne frecce
                const numCols = volleys[0].scores.length;

                const tableHtml = `
                    <div class="mt-4">
                        <h4 class="text-lg font-bold mb-2 text-primary-orange">${title}</h4>
                        <div class="grid-wrapper">
                            <table class="score-grid w-full table-auto min-w-[500px] border-collapse">
                                <thead>
                                    <tr class="text-xs sm:text-sm">
                                        <th class="w-[10%]">Volè</th>
                                        ${Array(numCols).fill(0).map((_, i) => `<th class="w-[8%]">${i + 1}</th>`).join('')}
                                        <th class="w-[10%]">Parz.</th>
                                        <th class="w-[10%]">Tot.</th>
                                        <th class="w-[12%]">X-10</th>
                                        <th class="w-[8%]">9</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${volleys.map((row, i) => `
                                        <tr class="${i % 2 === 0 ? 'bg-secondary-dark' : 'bg-gray-800'} text-xs sm:text-sm">
                                            <td class="font-bold">${row.volley}</td>
                                            ${row.scores.map(score => `<td>${score || ''}</td>`).join('')}
                                            <td class="font-bold text-white">${row.parziale}</td>
                                            <td class="font-bold text-white">${row.totale}</td>
                                            <td>${row.X10}</td>
                                            <td>${row.nine}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="bg-primary-orange text-black font-extrabold text-xs sm:text-sm">
                                        <td colspan="${1 + numCols + 1}" class="text-right pr-4">Totale Turno (${title})</td>
                                        <td class="font-extrabold">${turn.summary.score}</td>
                                        <td>${turn.summary.X}-${turn.summary.Ten}</td>
                                        <td>${turn.summary.Nine}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return tableHtml;
            }

            // Inizializza l'applicazione al caricamento dell'autenticazione
            window.setView('mainMenu');
        };
    </script>
</body>
</html>
